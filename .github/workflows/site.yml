name: Site

on: [push, pull_request]

env:
  CARGO_TERM_COLOR: always

jobs:
  site:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: 'Restore cache'
      uses: actions/cache/restore@v4
      with:
        key: ${{ runner.os }}-release-artifacts
        path: target

    - name: Setup
      run: |
        set -o pipefail
        cp target/release/url-cleaner-site urlcs

    - name: Order
      run: |
        ./urlcs &
        sleep 1
        ( echo '{"tasks":['; seq -s , -f '"https://%0.0f.com"' 127; echo ']}') | curl http://localhost:9149/clean -d @- | grep -oP 'http[^"]+' | sort -Vc
        kill $!

    - name: Unthreader
      run: |
        i=0
        mins=( 0 0 0  0 0 3  0 0 0  3 0 3 )
        maxs=( 3 3 3  3 3 5  3 3 3  5 3 5 )
        rems=( 0 0 0  0 0 3  0 0 0  3 0 3 )
        for default_unthread in '' '--default-unthread'; do
          for unthread_ratelimit in '' '--unthread-ratelimit 3'; do
            ./urlcs --cleaner example-cleaners/ratelimit-tester.json $default_unthread $unthread_ratelimit --port 9141 &
            for config in '' ',"unthread":false' ',"unthread":true'; do
              echo
              echo i=$i min=${mins[$i]} max=${maxs[$i]} rem=${rems[$i]}
              start=$(date +%s);
              curl http://localhost:9141/clean -d '{"tasks":["https://example.com","https://example.com"]'$config'}'
              time=$(($(date +%s) - $start))
              echo
              echo time=$time
              [[ ${mins[$i]} -le $time && $time -le ${maxs[$i]} ]]
              sleep ${rems[$i]}
              i=$(($i + 1))
            done
            kill $!
          done
        done


    - name: Profiles
      run: |
        set -e

        PROFILES='{"base":{"params_diff":{"flags":["unmobile"]}},"named":{"youtube_unshort":{"params_diff":{"flags":["youtube_unshort"]}}}}'
        PARAMS_DIFF1='{"unflags":["unmobile"]}'
        PARAMS_DIFF2='{"unflags":["unmobile"],"flags":["mobile"]}'

        ./urlcs --profiles <(echo "$PROFILES") |& tee site-run.log &
        site=$!
        while true; do
          sleep 0.1
          if ! kill -0 "$site"; then
            exit 1
          fi
          if grep "Rocket has launched" site-run.log; then
            break
          fi
        done

        diff -y <(
          curl -s http://127.0.0.1:9149/clean -d '{                                                               "tasks":["https://m.youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{                             "params_diff":'"$PARAMS_DIFF1"',  "tasks":["https://m.youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{"profile":"youtube_unshort"                                 ,  "tasks":["https://m.youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{"profile":"youtube_unshort", "params_diff":'"$PARAMS_DIFF1"',  "tasks":["https://m.youtube.com/shorts/abc"]}'; echo

          curl -s http://127.0.0.1:9149/clean -d '{                                                              "tasks":["https://youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{                             "params_diff":'"$PARAMS_DIFF2"', "tasks":["https://youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{"profile":"youtube_unshort"                                 , "tasks":["https://youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{"profile":"youtube_unshort", "params_diff":'"$PARAMS_DIFF2"', "tasks":["https://youtube.com/shorts/abc"]}'; echo
        ) <(
          echo '{"Ok":{"urls":[{"Ok":"https://www.youtube.com/shorts/abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://m.youtube.com/shorts/abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://www.youtube.com/watch?v=abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://m.youtube.com/watch?v=abc"}]}}'

          echo '{"Ok":{"urls":[{"Ok":"https://www.youtube.com/shorts/abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://m.youtube.com/shorts/abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://www.youtube.com/watch?v=abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://m.youtube.com/watch?v=abc"}]}}'
        )
