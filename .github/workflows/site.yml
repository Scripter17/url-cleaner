name: Site

on: [push, pull_request]

env:
  CARGO_TERM_COLOR: always

defaults:
  run:
    working-directory: site

jobs:
  order:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: order
      run: |
        set -o pipefail
        cargo run |& tee site-run.log &
        site=$!
        while true; do
          sleep 0.1
          if ! kill -0 "$site"; then
            exit 1
          fi
          if grep "Rocket has launched" site-run.log; then
            break
          fi
        done
        ( echo '{"tasks":['; seq -s , -f '"https://%0.0f.com"' 100; echo ']}') | curl http://localhost:9149/clean -d @- | grep -oP 'http[^"]+' | sort -Vc

  unthreader:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: unthreader
      run: |
        set -o pipefail
        cargo build

        cargo run -- --cleaner ../example-cleaners/ratelimit-tester.json &
        sleep 1

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"]}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"], "unthread": false}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"], "unthread": true}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        kill $!
        cargo run -- --cleaner ../example-cleaners/ratelimit-tester.json --unthread-ratelimit 1 &
        sleep 1

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"]}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"], "unthread": false}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"], "unthread": true}'
        end=$(date +%s)
        [[ 3 -le $(($end-$start)) && $(($end-$start)) -le 5 ]]

        kill $!
        cargo run -- --cleaner ../example-cleaners/ratelimit-tester.json --default-unthread &
        sleep 1

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"]}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"], "unthread": false}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"], "unthread": true}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        kill $!
        cargo run -- --cleaner ../example-cleaners/ratelimit-tester.json --default-unthread --unthread-ratelimit 1 &
        sleep 1

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"]}'
        end=$(date +%s)
        [[ 3 -le $(($end-$start)) && $(($end-$start)) -le 5 ]]

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"], "unthread": false}'
        end=$(date +%s)
        [[ 0 -le $(($end-$start)) && $(($end-$start)) -le 2 ]]

        start=$(date +%s)
        curl http://localhost:9149/clean -d '{"tasks":["https://example.com","https://example.com","https://example.com","https://example.com"], "unthread": true}'
        end=$(date +%s)
        [[ 3 -le $(($end-$start)) && $(($end-$start)) -le 5 ]]

        kill $!

  profiles:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: profiles
      run: |
        set -e

        PROFILES='{"base":{"params_diff":{"flags":["unmobile"]}},"named":{"youtube_unshort":{"params_diff":{"flags":["youtube_unshort"]}}}}'
        PARAMS_DIFF1='{"unflags":["unmobile"]}'
        PARAMS_DIFF2='{"unflags":["unmobile"],"flags":["mobile"]}'

        cargo run -- --profiles <(echo "$PROFILES") |& tee site-run.log &
        site=$!
        while true; do
          sleep 0.1
          if ! kill -0 "$site"; then
            exit 1
          fi
          if grep "Rocket has launched" site-run.log; then
            break
          fi
        done

        cargo build

        diff -y <(
          curl -s http://127.0.0.1:9149/clean -d '{                                                               "tasks":["https://m.youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{                             "params_diff":'"$PARAMS_DIFF1"',  "tasks":["https://m.youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{"profile":"youtube_unshort"                                 ,  "tasks":["https://m.youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{"profile":"youtube_unshort", "params_diff":'"$PARAMS_DIFF1"',  "tasks":["https://m.youtube.com/shorts/abc"]}'; echo

          curl -s http://127.0.0.1:9149/clean -d '{                                                              "tasks":["https://youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{                             "params_diff":'"$PARAMS_DIFF2"', "tasks":["https://youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{"profile":"youtube_unshort"                                 , "tasks":["https://youtube.com/shorts/abc"]}'; echo
          curl -s http://127.0.0.1:9149/clean -d '{"profile":"youtube_unshort", "params_diff":'"$PARAMS_DIFF2"', "tasks":["https://youtube.com/shorts/abc"]}'; echo
        ) <(
          echo '{"Ok":{"urls":[{"Ok":"https://www.youtube.com/shorts/abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://m.youtube.com/shorts/abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://www.youtube.com/watch?v=abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://m.youtube.com/watch?v=abc"}]}}'

          echo '{"Ok":{"urls":[{"Ok":"https://www.youtube.com/shorts/abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://m.youtube.com/shorts/abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://www.youtube.com/watch?v=abc"}]}}'
          echo '{"Ok":{"urls":[{"Ok":"https://m.youtube.com/watch?v=abc"}]}}'
        )
