name: CLI

on: [push, pull_request]

env:
  CARGO_TERM_COLOR: always
  CARGO_PROFILE_dev_DEBUG: 0

jobs:
  cli:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup
      run: |
        set -euo pipefail
        cargo build --bin url-cleaner
        cp target/debug/url-cleaner urlc

    - name: Output
      run: |
        for args in 0 1 10; do
          for stdin in 0 1 10 100 1000 10000 100000; do
            diff\
              <(seq -f "https://example.com/stdin/%0.0f" $stdin | ./urlc $(seq -f "https://example.com/arg/%0.0f" $args))\
              <(seq -f "https://example.com/arg/%0.0f" $args; seq -f "https://example.com/stdin/%0.0f" $stdin)
          done
        done

    - name: Profiles
      run: |
        PROFILES='
        {
          "base": {
            "params_diff": {
              "vars": {
                "client_type": "desktop"
              }
            }
          },
          "named": {
            "youtube unshort": {
              "params_diff": {
                "flags": ["youtube_unshort"]
              }
            }
          }
        }'
        PARAMS_DIFF1='{"unvars": ["client_type"]}'
        PARAMS_DIFF2='{"vars": {"client_type": "mobile"}}'

        diff -y <(
          ./urlc --profiles <(echo "$PROFILES")                                                                   'https://m.youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES")                             --params-diff <(echo "$PARAMS_DIFF1") 'https://m.youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES") --profile "youtube unshort"                                       'https://m.youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES") --profile "youtube unshort" --params-diff <(echo "$PARAMS_DIFF1") 'https://m.youtube.com/shorts/abc'

          ./urlc --profiles <(echo "$PROFILES")                                                                   'https://youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES")                             --params-diff <(echo "$PARAMS_DIFF2") 'https://youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES") --profile "youtube unshort"                                       'https://youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES") --profile "youtube unshort" --params-diff <(echo "$PARAMS_DIFF2") 'https://youtube.com/shorts/abc'
        ) <(
          echo 'https://www.youtube.com/shorts/abc'
          echo   'https://m.youtube.com/shorts/abc'
          echo 'https://www.youtube.com/watch?v=abc'
          echo   'https://m.youtube.com/watch?v=abc'
          echo 'https://www.youtube.com/shorts/abc'
          echo   'https://m.youtube.com/shorts/abc'
          echo 'https://www.youtube.com/watch?v=abc'
          echo   'https://m.youtube.com/watch?v=abc'
        )

        diff <(./urlc --profiles <(echo "$PROFILES") --profile unknown |& cat) <(echo 'Error: ProfileNotFound')

    - name: 'Check bundled cleaner'
      run: cargo run --bin urlc-tool -- test --filter '^offline' --assert-suitability
