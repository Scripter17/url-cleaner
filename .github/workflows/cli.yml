name: CLI

on: [push, pull_request]

env:
  CARGO_TERM_COLOR: always
  CARGO_PROFILE_dev_DEBUG: 0

jobs:
  cli:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Setup
      run: |
        set -euo pipefail
        cargo build -p url-cleaner
        cp target/debug/url-cleaner urlc

    - name: Order
      run: |
        in=$(seq -f "https://%0.0f.com/" 127)

        [[ "$(echo "$in" | ./urlc    )" == "$in" ]]
        [[ "$(             ./urlc $in)" == "$in" ]]
        [[ "$(echo "$in" | ./urlc $in)" == "$(echo -ne "$in\n$in")" ]]

    - name: Profiles
      run: |
        PROFILES='{"base":{"params_diff":{"flags":["unmobile"]}},"named":{"youtube_unshort":{"params_diff":{"flags":["youtube_unshort"]}}}}'
        PARAMS_DIFF1='{"unflags":["unmobile"]}'
        PARAMS_DIFF2='{"unflags":["unmobile"],"flags":["mobile"]}'

        diff -y <(
          ./urlc --profiles <(echo "$PROFILES")                                                                 'https://m.youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES")                           --params-diff <(echo "$PARAMS_DIFF1") 'https://m.youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES") --profile youtube_unshort                                       'https://m.youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES") --profile youtube_unshort --params-diff <(echo "$PARAMS_DIFF1") 'https://m.youtube.com/shorts/abc'

          ./urlc --profiles <(echo "$PROFILES")                                                                 'https://youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES")                           --params-diff <(echo "$PARAMS_DIFF2") 'https://youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES") --profile youtube_unshort                                       'https://youtube.com/shorts/abc'
          ./urlc --profiles <(echo "$PROFILES") --profile youtube_unshort --params-diff <(echo "$PARAMS_DIFF2") 'https://youtube.com/shorts/abc'
        ) <(
          echo 'https://www.youtube.com/shorts/abc'
          echo   'https://m.youtube.com/shorts/abc'
          echo 'https://www.youtube.com/watch?v=abc'
          echo   'https://m.youtube.com/watch?v=abc'
          echo 'https://www.youtube.com/shorts/abc'
          echo   'https://m.youtube.com/shorts/abc'
          echo 'https://www.youtube.com/watch?v=abc'
          echo   'https://m.youtube.com/watch?v=abc'
        )

        diff <(./urlc --profiles <(echo "$PROFILES") --profile unknown |& cat) <(echo 'Error: ProfileNotFound')
